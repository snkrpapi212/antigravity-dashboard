<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Antigravity Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script crossorigin src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
  <script crossorigin src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: {
            bg: '#0b1220',
            panel: '#111827',
            panel2: '#1f2937',
            borderc: '#334155',
            primary: '#6366f1',
            success: '#22c55e',
            danger: '#f43f5e',
            warn: '#f59e0b'
          },
          boxShadow: {
            soft: '0 10px 24px -18px rgba(2, 6, 23, 0.95)',
            ring: '0 0 0 1px rgba(99,102,241,0.22), 0 14px 40px -28px rgba(99,102,241,0.55)'
          }
        }
      }
    }
  </script>

  <style>
    :root {
      --bg-0: #070d1a;
      --bg-1: #0b1220;
      --bg-2: #111827;
      --line: rgba(148,163,184,.16);
      --line-soft: rgba(148,163,184,.10);
      --text-soft: #94a3b8;
      --primary: #6366f1;
      --primary-2: #818cf8;
    }

    body {
      font-family: Inter, system-ui, sans-serif;
      background: radial-gradient(1400px 700px at 20% -10%, rgba(99,102,241,.18), transparent 45%),
                  radial-gradient(900px 600px at 80% -10%, rgba(16,185,129,.08), transparent 45%),
                  linear-gradient(180deg, var(--bg-0), var(--bg-1));
    }

    .glass {
      background: linear-gradient(180deg, rgba(17,24,39,.78), rgba(15,23,42,.78));
      backdrop-filter: blur(12px);
      border: 1px solid var(--line);
      box-shadow: 0 1px 0 rgba(255,255,255,.03) inset;
    }

    .card {
      background: linear-gradient(180deg, rgba(30,41,59,.76), rgba(15,23,42,.92));
      border: 1px solid var(--line);
      box-shadow: 0 12px 30px -26px rgba(2, 6, 23, .95);
      transition: border-color .2s ease, transform .2s ease, box-shadow .25s ease;
    }

    .card:hover {
      border-color: rgba(148,163,184,.25);
      transform: translateY(-1px);
      box-shadow: 0 16px 30px -24px rgba(2, 6, 23, .95);
    }

    .fade-up { animation: fadeUp .42s cubic-bezier(.2,.75,.2,1) both; }
    @keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

    .skeleton {
      background: linear-gradient(90deg, rgba(51,65,85,.3), rgba(71,85,105,.48), rgba(51,65,85,.3));
      background-size: 200% 100%;
      animation: shimmer 1.2s linear infinite;
      border-radius: 10px;
    }
    @keyframes shimmer { from { background-position: 200% 0 } to { background-position: -200% 0 } }

    .focus-ring:focus-visible {
      outline: none;
      box-shadow: 0 0 0 3px rgba(99,102,241,.28);
      border-color: rgba(99,102,241,.45) !important;
    }

    .kpi-value {
      letter-spacing: -.03em;
      line-height: 1;
      text-wrap: balance;
      font-variant-numeric: tabular-nums;
    }

    .section-kicker {
      font-size: 11px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: #94a3b8;
      font-weight: 600;
    }

    .metric-pill-value {
      font-variant-numeric: tabular-nums;
      letter-spacing: -.01em;
    }

    .pill {
      border: 1px solid var(--line-soft);
      background: rgba(15,23,42,.55);
    }
  </style>
</head>
<body class="dark text-slate-100 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useMemo, useState, useEffect, createContext, useContext } = React;
    const {
      ResponsiveContainer,
      LineChart, Line,
      BarChart, Bar,
      XAxis, YAxis, CartesianGrid, Tooltip, Legend
    } = window.Recharts || {};

    const DashboardContext = createContext(null);

    const formatCurrency = (n) => new Intl.NumberFormat('en-US', {
      style: 'currency', currency: 'USD', maximumFractionDigits: 0
    }).format(n);

    const formatCompact = (n) => new Intl.NumberFormat('en-US', {
      notation: 'compact', maximumFractionDigits: 1
    }).format(n);

    function generateBaseData() {
      return Array.from({ length: 180 }, (_, i) => {
        const d = new Date();
        d.setDate(d.getDate() - (179 - i));
        const x = i + 1;
        const revenue = 11000 + x * 31 + Math.sin(x / 7) * 1500 + (Math.random() - 0.5) * 1100;
        const users = 850 + x * 2.6 + Math.sin(x / 6) * 80 + (Math.random() - 0.5) * 65;
        const conversion = 3 + Math.sin(x / 11) * 0.7 + (Math.random() - 0.5) * 0.3;
        return {
          date: d,
          label: d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
          revenue: Math.max(3500, Math.round(revenue)),
          users: Math.max(220, Math.round(users)),
          conversion: Number(Math.max(1.4, Math.min(8.8, conversion)).toFixed(2))
        };
      });
    }

    const BASE_DATA = generateBaseData();
    const MULTIPLIER = { All: 1, Enterprise: 1.32, SMB: 1.07, Consumer: 0.83 };

    function MiniSparkline({ values, up }) {
      const w = 122, h = 30;
      const min = Math.min(...values), max = Math.max(...values);
      const range = max - min || 1;
      const pts = values.map((v, i) => `${(i / (values.length - 1)) * w},${h - ((v - min) / range) * h}`).join(' ');
      return (
        <svg width={w} height={h} viewBox={`0 0 ${w} ${h}`} aria-hidden="true">
          <polyline points={pts} fill="none" stroke={up ? '#22c55e' : '#f43f5e'} strokeWidth="2.25" />
        </svg>
      );
    }

    function KpiCard({ label, value, delta, comparison, spark, tone = 'default', onClick }) {
      const up = delta >= 0;
      const toneClass = tone === 'primary' ? 'text-indigo-300' : tone === 'success' ? 'text-emerald-300' : tone === 'warn' ? 'text-amber-300' : 'text-slate-100';

      return (
        <article
          className="card rounded-2xl p-5 cursor-pointer"
          role="button"
          tabIndex={0}
          onClick={onClick}
          onKeyDown={(e) => (e.key === 'Enter' || e.key === ' ') && onClick?.()}
          aria-label={`${label} metric card`}
        >
          <div className="flex justify-between items-start gap-3">
            <p className="text-sm text-slate-300 font-medium">{label}</p>
            <span className={`text-xs px-2 py-1 rounded-full ${up ? 'bg-emerald-500/15 text-emerald-300' : 'bg-rose-500/15 text-rose-300'}`}>
              {up ? '↑' : '↓'} {Math.abs(delta).toFixed(1)}% {comparison}
            </span>
          </div>

          <p className={`kpi-value text-[2rem] leading-none font-extrabold mt-3 ${toneClass}`}>{value}</p>

          <div className="mt-3 flex items-center justify-between gap-3">
            <MiniSparkline values={spark} up={up} />
            <span className="text-[11px] text-slate-500">last 20 points</span>
          </div>
        </article>
      );
    }

    function Widget({ title, subtitle, onRefresh, onRetry, loading, error, children }) {
      return (
        <section className="card rounded-2xl overflow-hidden fade-up">
          <header className="px-5 py-4 border-b border-slate-700/70 flex items-start justify-between gap-4">
            <div>
              <h3 className="font-semibold tracking-tight">{title}</h3>
              {subtitle ? <p className="text-xs text-slate-400 mt-1">{subtitle}</p> : null}
            </div>

            <div className="flex items-center gap-2 shrink-0">
              <button onClick={onRefresh} className="focus-ring text-xs px-2.5 py-1 rounded-lg border border-slate-600 hover:bg-slate-700/40">Refresh</button>
              <button className="focus-ring text-xs px-2.5 py-1 rounded-lg border border-slate-600 hover:bg-slate-700/40">Export</button>
            </div>
          </header>

          <div className="p-5 min-h-[240px]">
            {loading ? (
              <div className="space-y-3" aria-busy="true" aria-live="polite">
                <div className="h-5 w-1/3 skeleton"></div>
                <div className="h-40 skeleton"></div>
                <div className="h-4 w-2/3 skeleton"></div>
              </div>
            ) : error ? (
              <div className="h-full min-h-[180px] grid place-items-center text-center">
                <div>
                  <p className="text-rose-300 font-medium mb-2">Failed to load widget</p>
                  <button onClick={onRetry} className="focus-ring text-xs px-3 py-1.5 rounded-lg bg-rose-500/20 text-rose-200 border border-rose-500/30">Retry</button>
                </div>
              </div>
            ) : children}
          </div>
        </section>
      );
    }

    function MetricPill({ label, value }) {
      return (
        <div className="pill rounded-xl px-3 py-2">
          <p className="text-[11px] text-slate-400">{label}</p>
          <p className="metric-pill-value text-sm font-semibold mt-0.5">{value}</p>
        </div>
      );
    }

    function DashboardBody() {
      const { filters, refreshNonce, selectedKpi, setSelectedKpi } = useContext(DashboardContext);
      const [loading, setLoading] = useState(false);
      const [errors, setErrors] = useState({ line: false, bar: false, table: false });

      useEffect(() => {
        setLoading(true);
        const t = setTimeout(() => {
          setLoading(false);
          setErrors({ line: false, bar: false, table: false });
        }, 650);
        return () => clearTimeout(t);
      }, [filters.range, filters.category, refreshNonce]);

      const filtered = useMemo(() => {
        const n = filters.range === 'all' ? 180 : Number(filters.range);
        const m = MULTIPLIER[filters.category] || 1;
        return BASE_DATA.slice(-n).map(d => ({
          ...d,
          revenue: Math.round(d.revenue * m),
          users: Math.round(d.users * (0.9 + m * 0.13)),
          conversion: Number(Math.min(10, d.conversion * (0.93 + m * 0.08)).toFixed(2))
        }));
      }, [filters]);

      const previous = useMemo(() => {
        const n = filters.range === 'all' ? 180 : Number(filters.range);
        return BASE_DATA.slice(-(n * 2), -n);
      }, [filters.range]);

      const kpis = useMemo(() => {
        const sumRevenue = filtered.reduce((a,b)=>a+b.revenue,0);
        const sumUsers = filtered.reduce((a,b)=>a+b.users,0);
        const avgConv = filtered.reduce((a,b)=>a+b.conversion,0) / filtered.length;
        const growth = ((filtered.at(-1).revenue - filtered[0].revenue) / filtered[0].revenue) * 100;

        const prevRevenue = previous.reduce((a,b)=>a+b.revenue,0) || 1;
        const prevUsers = previous.reduce((a,b)=>a+b.users,0) || 1;
        const prevConv = previous.length ? previous.reduce((a,b)=>a+b.conversion,0) / previous.length : 1;
        const prevGrowth = previous.length > 1 ? ((previous.at(-1).revenue - previous[0].revenue) / previous[0].revenue) * 100 : growth;

        return {
          revenue: { label: 'Revenue', value: formatCurrency(sumRevenue), delta: ((sumRevenue - prevRevenue) / prevRevenue) * 100, spark: filtered.slice(-20).map(x=>x.revenue) },
          users: { label: 'Users', value: formatCompact(sumUsers), delta: ((sumUsers - prevUsers) / prevUsers) * 100, spark: filtered.slice(-20).map(x=>x.users) },
          conversion: { label: 'Conversion', value: `${avgConv.toFixed(2)}%`, delta: ((avgConv - prevConv) / prevConv) * 100, spark: filtered.slice(-20).map(x=>x.conversion) },
          growth: { label: 'Growth', value: `${growth >= 0 ? '+' : ''}${growth.toFixed(1)}%`, delta: growth - prevGrowth, spark: filtered.slice(-20).map((x,i,arr)=> i===0?0:((x.revenue-arr[i-1].revenue)/arr[i-1].revenue)*100) }
        };
      }, [filtered, previous]);

      const barData = useMemo(() => {
        const out = [];
        const size = Math.max(4, Math.floor(filtered.length / 9));
        for (let i=0; i<filtered.length; i+=size) {
          const block = filtered.slice(i, i + size);
          out.push({
            label: block[Math.floor(block.length / 2)]?.label || '',
            users: Math.round(block.reduce((a,b)=>a+b.users,0) / block.length),
            conversion: Number((block.reduce((a,b)=>a+b.conversion,0) / block.length).toFixed(2))
          });
        }
        return out;
      }, [filtered]);

      const topRows = useMemo(() => {
        return [
          { product: 'Quantum Pro', revenue: 124000, users: 8800, growth: 14.2 },
          { product: 'Neural Team', revenue: 91300, users: 6400, growth: 6.5 },
          { product: 'Orbit SMB', revenue: 78200, users: 5900, growth: -2.1 },
          { product: 'Nova Consumer', revenue: 66300, users: 9100, growth: 3.3 },
          { product: 'Atlas Platform', revenue: 58800, users: 4200, growth: 9.7 }
        ].map(r => ({ ...r, revenue: Math.round(r.revenue * (MULTIPLIER[filters.category] || 1)) }));
      }, [filters.category]);

      return (
        <div className="max-w-7xl mx-auto p-4 md:p-8 space-y-6 md:space-y-7">
          <div>
            <p className="section-kicker mb-3">Core KPIs</p>
            <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
            <KpiCard label="Revenue" value={kpis.revenue.value} delta={kpis.revenue.delta} comparison="vs prev" spark={kpis.revenue.spark} tone="primary" onClick={() => setSelectedKpi(kpis.revenue)} />
            <KpiCard label="Users" value={kpis.users.value} delta={kpis.users.delta} comparison="vs prev" spark={kpis.users.spark} onClick={() => setSelectedKpi(kpis.users)} />
            <KpiCard label="Conversion" value={kpis.conversion.value} delta={kpis.conversion.delta} comparison="vs prev" spark={kpis.conversion.spark} tone="success" onClick={() => setSelectedKpi(kpis.conversion)} />
            <KpiCard label="Growth" value={kpis.growth.value} delta={kpis.growth.delta} comparison="vs prev" spark={kpis.growth.spark} tone="warn" onClick={() => setSelectedKpi(kpis.growth)} />
            </div>
          </div>

          <div>
            <p className="section-kicker mb-3">Trend Analysis</p>
            <div className="grid grid-cols-1 xl:grid-cols-12 gap-4">
            <div className="xl:col-span-8">
              <Widget
                title="Revenue Trend"
                subtitle="Daily revenue performance"
                loading={loading}
                error={errors.line}
                onRefresh={() => setLoading(true) || setTimeout(()=>setLoading(false), 500)}
                onRetry={() => setErrors(s => ({ ...s, line: false }))}
              >
                <div className="h-72">
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={filtered}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                      <XAxis dataKey="label" minTickGap={24} tick={{ fill: '#94a3b8', fontSize: 11 }} />
                      <YAxis tick={{ fill: '#94a3b8', fontSize: 11 }} tickFormatter={(v)=>`$${Math.round(v/1000)}k`} />
                      <Tooltip
                        contentStyle={{ background: '#0f172a', border: '1px solid #334155', borderRadius: '10px' }}
                        formatter={(v)=>formatCurrency(v)}
                        labelStyle={{ color: '#cbd5e1' }}
                      />
                      <Line type="monotone" dataKey="revenue" stroke="#818cf8" strokeWidth={3} dot={false} activeDot={{ r: 5 }} />
                    </LineChart>
                  </ResponsiveContainer>
                </div>
              </Widget>
            </div>

            <div className="xl:col-span-4">
              <Widget
                title="Users & Conversion"
                subtitle="Average by period bucket"
                loading={loading}
                error={errors.bar}
                onRefresh={() => setLoading(true) || setTimeout(()=>setLoading(false), 500)}
                onRetry={() => setErrors(s => ({ ...s, bar: false }))}
              >
                <div className="h-72">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={barData}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                      <XAxis dataKey="label" tick={{ fill: '#94a3b8', fontSize: 11 }} />
                      <YAxis yAxisId="left" tick={{ fill: '#94a3b8', fontSize: 11 }} />
                      <YAxis yAxisId="right" orientation="right" tickFormatter={(v)=>`${v}%`} tick={{ fill: '#94a3b8', fontSize: 11 }} />
                      <Tooltip contentStyle={{ background: '#0f172a', border: '1px solid #334155', borderRadius: '10px' }} />
                      <Legend wrapperStyle={{ color: '#cbd5e1' }} />
                      <Bar yAxisId="left" dataKey="users" fill="#60a5fa" radius={[8,8,0,0]} />
                      <Bar yAxisId="right" dataKey="conversion" fill="#f472b6" radius={[8,8,0,0]} />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </Widget>
            </div>
            </div>
          </div>

          <div>
            <p className="section-kicker mb-3">Product Performance</p>
          <Widget
            title="Top Products"
            subtitle="Coordinated with global filters"
            loading={loading}
            error={errors.table}
            onRefresh={() => setLoading(true) || setTimeout(()=>setLoading(false), 500)}
            onRetry={() => setErrors(s => ({ ...s, table: false }))}
          >
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="text-left text-slate-400 border-b border-slate-700">
                    <th className="py-2">Product</th>
                    <th className="py-2">Revenue</th>
                    <th className="py-2">Users</th>
                    <th className="py-2">Growth</th>
                    <th className="py-2">Status</th>
                  </tr>
                </thead>
                <tbody>
                  {topRows.map((r) => {
                    const status = r.growth > 8 ? 'Outperform' : r.growth >= 0 ? 'Stable' : 'Declining';
                    const statusClass = r.growth > 8
                      ? 'bg-emerald-500/15 text-emerald-300'
                      : r.growth >= 0 ? 'bg-amber-500/15 text-amber-300' : 'bg-rose-500/15 text-rose-300';
                    return (
                      <tr key={r.product} className="border-b border-slate-800/80 hover:bg-slate-700/20 transition-colors">
                        <td className="py-3 font-medium">{r.product}</td>
                        <td className="py-3">{formatCurrency(r.revenue)}</td>
                        <td className="py-3">{formatCompact(r.users)}</td>
                        <td className={`py-3 ${r.growth >= 0 ? 'text-emerald-300' : 'text-rose-300'}`}>{r.growth >= 0 ? '+' : ''}{r.growth.toFixed(1)}%</td>
                        <td className="py-3"><span className={`text-xs px-2 py-1 rounded-full ${statusClass}`}>{status}</span></td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </Widget>
          </div>

          {selectedKpi ? (
            <div className="glass rounded-2xl p-4 md:p-5 fade-up">
              <p className="text-xs text-slate-400">KPI Drill-down</p>
              <p className="mt-1 text-lg font-semibold">{selectedKpi.label}</p>
              <p className="text-sm text-slate-300 mt-1">Current value: <span className="font-semibold">{selectedKpi.value}</span></p>
              <p className="text-sm text-slate-400 mt-1">This is a placeholder drill-down panel (staff-level interaction pattern).</p>
            </div>
          ) : null}
        </div>
      );
    }

    function App() {
      const [filters, setFilters] = useState({ range: '30', category: 'All' });
      const [refreshNonce, setRefreshNonce] = useState(0);
      const [theme, setTheme] = useState('dark');
      const [selectedKpi, setSelectedKpi] = useState(null);

      useEffect(() => {
        document.documentElement.classList.toggle('dark', theme === 'dark');
      }, [theme]);

      if (!window.Recharts || !LineChart) {
        return <div className="min-h-screen grid place-items-center p-6 text-center text-slate-300">Unable to load chart libraries. Ensure internet access and open via local server.</div>;
      }

      return (
        <DashboardContext.Provider value={{ filters, setFilters, refreshNonce, theme, selectedKpi, setSelectedKpi }}>
          <div className="max-w-7xl mx-auto p-4 md:p-8">
            <header className="glass rounded-2xl p-5 md:p-6">
              <div className="flex flex-col xl:flex-row gap-4 xl:items-center xl:justify-between">
                <div>
                  <h1 className="text-3xl md:text-4xl font-extrabold tracking-tight">Antigravity Dashboard</h1>
                  <p className="text-slate-400 mt-1">Executive command center with coordinated filters and widget states.</p>
                  <div className="mt-3 flex gap-2 flex-wrap">
                    <MetricPill label="Region" value="Global" />
                    <MetricPill label="Latency" value="128ms" />
                    <MetricPill label="Last sync" value="just now" />
                  </div>
                </div>

                <div className="flex flex-wrap items-center gap-2">
                  <div className="glass rounded-xl px-3 py-2 border border-slate-600/60">
                    <label className="text-xs text-slate-400 mr-2">Date range</label>
                    <select
                      value={filters.range}
                      onChange={(e)=>setFilters(f=>({ ...f, range: e.target.value }))}
                      className="focus-ring bg-transparent text-sm outline-none rounded"
                      aria-label="Date range"
                    >
                      <option className="text-black" value="7">Last 7 days</option>
                      <option className="text-black" value="30">Last 30 days</option>
                      <option className="text-black" value="90">Last 90 days</option>
                      <option className="text-black" value="all">All data</option>
                    </select>
                  </div>

                  <div className="glass rounded-xl px-3 py-2 border border-slate-600/60">
                    <label className="text-xs text-slate-400 mr-2">Category</label>
                    <select
                      value={filters.category}
                      onChange={(e)=>setFilters(f=>({ ...f, category: e.target.value }))}
                      className="focus-ring bg-transparent text-sm outline-none rounded"
                      aria-label="Category"
                    >
                      <option className="text-black" value="All">All</option>
                      <option className="text-black" value="Enterprise">Enterprise</option>
                      <option className="text-black" value="SMB">SMB</option>
                      <option className="text-black" value="Consumer">Consumer</option>
                    </select>
                  </div>

                  <button onClick={() => setRefreshNonce(n => n + 1)} className="focus-ring text-sm px-3 py-2 rounded-xl border border-slate-600 hover:bg-slate-700/40">Refresh</button>
                  <button className="focus-ring text-sm px-3 py-2 rounded-xl border border-slate-600 hover:bg-slate-700/40">Export</button>
                  <button onClick={() => setTheme(t => t === 'dark' ? 'light' : 'dark')} className="focus-ring text-sm px-3 py-2 rounded-xl border border-slate-600 hover:bg-slate-700/40">Theme</button>
                </div>
              </div>
            </header>
          </div>

          <DashboardBody />
        </DashboardContext.Provider>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
